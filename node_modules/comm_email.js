
/*
 * @class AD.Comm.Email
 * @parent AD.Comm
 * 
 * An object to send email using the node mailer module
 */

var mailer, mandrill;
var _sendMail;

/**
 * @function _mandrillMail
 * Send email using the Mandrill service.
 */
var _mandrillMail = function(data, next)
{
    var opts = {
        type: 'messages',
        call: 'send',
        key: AD.Defaults.emailKey,
        message: {
            to: [{ email: data['to'] }],
            from_email: data['from'],
            subject: data['subject'],
            html: data['body']
        }
    };
    mandrill.call(opts, function(response) {
    
        next && next();
    
    });
}


/**
 * @function _smtpMail
 * Send email using a normal SMTP server, as configured during installation.
 */
var _smtpMail = function(data, next) 
{
    var mailhost = AD.Defaults.emailHost || "securemail.zteam.biz";
    var mailport = AD.Defaults.emailPort || "25";
    var maildomain = AD.Defaults.emailDomain || "localhost";

    mailer.send({
	  host : mailhost,              // smtp server hostname
	  port : mailport,                     // smtp server port
	  domain : maildomain,            // domain used by client to identify itself to server
	  to : data['to'],
	  from : data['from'],
	  subject : data['subject'],
	  body: data['body']
	  //authentication : "login",        // auth login is supported; anything else is no auth
	  //username : data['smtpuser'],       // Base64 encoded username
	  //password : data['smtppass']        // Base64 encoded password
	},
	
	function(err, result){
	  if(err) { 
		  next(err); 
	  }
	  else { 
		  next(); 
	  }
	  
	});
}

switch (AD.Defaults.emailMethod.toLowerCase()) {
    default:
    case 'smtp': 
        mailer = require('mailer');
        _sendMail = _smtpMail;
        break;
        
    case 'mandrill':
        mandrill = require('mandrill');
        _sendMail = _mandrillMail;
        break;
}


/*
 * @function sendMail
 * 
 * ##sendMail
 * A function taking in email parameters in the data object and using `mailer` to send the email.
 * 
 * @param {Object} req
 * @param {Object} res
 * @param {Object} data
 * @param {Function} callback
 */
exports.sendMail = function(req, res, data, callback) 
{
    _sendMail(data, callback);

}

